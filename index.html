<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>多人即時彈幕攻擊主播</title>
<style>
  body { margin: 0; overflow: hidden; background: #222; color: #fff; font-family: sans-serif; }
  #chatInput { position: absolute; bottom: 10px; left: 10px; width: 300px; }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<input type="text" id="chatInput" placeholder="輸入彈幕文字按Enter">

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const bullets = [];
const player = { x: 100, y: canvas.height/2-50, width:100, height:100, hp:100, speed:10 };
let keys = {};
document.addEventListener('keydown', e => keys[e.key] = true);
document.addEventListener('keyup', e => keys[e.key] = false);

// 連線 WebSocket 伺服器
const ws = new WebSocket('ws://localhost:8080');

// 隨機顏色
function getRandomColor() {
  const colors = ['yellow','cyan','lime','magenta','orange','pink','white'];
  return colors[Math.floor(Math.random()*colors.length)];
}

// 收到彈幕訊息
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  bullets.push({
    text: `${data.user}: ${data.msg}`,
    x: canvas.width,
    y: Math.random()*(canvas.height-30),
    speed: 3 + data.msg.length*0.1,
    color: getRandomColor()
  });
};

// 輸入彈幕
document.getElementById('chatInput').addEventListener('keydown', function(e){
  if(e.key==='Enter' && this.value.trim()!==''){
    const msg = this.value.trim();
    const user = prompt("輸入你的名稱", "玩家") || "玩家";
    ws.send(JSON.stringify({ user, msg }));
    this.value='';
  }
});

// 遊戲主循環
function gameLoop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 玩家閃避控制
  if(keys['ArrowUp'] || keys['w']) player.y -= player.speed;
  if(keys['ArrowDown'] || keys['s']) player.y += player.speed;
  if(player.y < 0) player.y = 0;
  if(player.y+player.height>canvas.height) player.y = canvas.height-player.height;

  // 畫主播
  ctx.fillStyle='red';
  ctx.fillRect(player.x, player.y, player.width, player.height);
  ctx.fillStyle='white';
  ctx.font='20px sans-serif';
  ctx.fillText(`HP: ${player.hp}`, player.x, player.y-10);

  // 畫彈幕
  bullets.forEach((b,index)=>{
    ctx.fillStyle=b.color;
    ctx.fillText(b.text,b.x,b.y);
    b.x -= b.speed;

    if(b.x < player.x + player.width && b.x + ctx.measureText(b.text).width > player.x &&
       b.y < player.y + player.height && b.y > player.y){
      player.hp -= 5;
      bullets.splice(index,1);
    }

    if(b.x + ctx.measureText(b.text).width < 0) bullets.splice(index,1);
  });

  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>

</body>
</html>